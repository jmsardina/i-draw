$(function(){
  setUpEnvironment();
  setVariables();
});

function setVariables(){
  var paint;
  mouseCoordinates = new Array();
  var canvas = document.getElementById("canvas");
  var dataURL = canvas.toDataURL();
  undoArray = [dataURL]
}

function listenOnMouse(){
  $("#canvas").on("mousedown", mouseDown);

  function mouseDown(e){
    paint = true;
    
    recordHistory();
    mouseCoordinates.push([e.offsetX, e.offsetY]);
    $(this).on("mousemove", mouseMove);
  }

  function mouseMove(e){
    if(paint){
      mouseCoordinates.push([e.offsetX, e.offsetY]);
      $(this).on("mouseup", mouseUp);
      draw(e);
    }
  }

  function mouseUp(e){
    paint = false;
    context.beginPath();
    context.arc(e.offsetX, e.offsetY, context.lineWidth/2, 0, Math.PI*2, true);
    context.closePath();
    context.fillStyle = context.strokeStyle
    context.fill();
  }
}

function draw(e){
  if(paint){
    context.beginPath();
    context.lineJoin = "round";
    context.lineCap = "round";

    context.moveTo(mouseCoordinates[mouseCoordinates.length-2][0], mouseCoordinates[mouseCoordinates.length-2][1]);
    context.lineTo(mouseCoordinates[mouseCoordinates.length-1][0], mouseCoordinates[mouseCoordinates.length-1][1]);
    mouseCoordinates.splice(-2, 1);
    context.stroke();
  }
}

function recordHistory(){
  var canvas = document.getElementById("canvas");
  var dataURL = canvas.toDataURL();
  undoArray.push(dataURL);
  redoArray = new Array();
}

function listenOnCanvasClearing(){
  $("#start-over").on("click", clearCanvas);
  $("#remove-image").on("click", completeDrawing);
  $("#eraser").on("click", erasing);
  $("#js-undo").on("click", undo);
  $("#js-redo").on("click", redo);

  function erasing(){
    context.globalCompositeOperation = "destination-out";
    $("#canvas").attr("class", "erasing");
  }
 
  function clearCanvas(){
    if(confirm("We're about to erase your picture!")){
      context.clearRect(0, 0, canvas.width, canvas.height);
    }
  }

  function completeDrawing(){
    if(confirm("Are you sure you're done?")){
      imageHolderContext.clearRect(0, 0, canvas.width, canvas.height);
      if($("#profile").hasClass("coloring")){
        context.drawImage(currentImage, canvas.width/60+85, 10, canvas.width/1.3, canvas.height-18);
      }
    }
  }

  function undo(){
    if((redoArray.length === 0) & (undoArray.length >= 1)){
      var canvas = document.getElementById("canvas");
      var dataURL = canvas.toDataURL();
      redoArray.unshift(dataURL);
    }
    if(undoArray.length >= 1){
      context.clearRect(0, 0, $("#canvas").width(), $("#canvas").height());
      var image = document.createElement("img");
   
      redoArray.unshift(undoArray.pop());
      image.setAttribute("src", redoArray[0]);
      context.drawImage(image, 0, 0);
    }
  }

  function redo(){
    if(redoArray.length >= 1){
      context.clearRect(0, 0, canvas.width, canvas.height);
      var image = document.createElement("img");

      undoArray.push(redoArray.shift())
      image.setAttribute("src", undoArray[undoArray.length-1]);
      context.drawImage(image, 0, 0);
    }
  }
}