$(function(){
  setUpEnvironment();
  var paint;
  mouseCoordinates = new Array();
});

function chooseImage(){
  chooseCartoon();
  function chooseCartoon(){
    <% Cartoon.all.each do |cartoon| %>
      $("#cartoon-<%= cartoon.id %>").on("click", chooseCartoon<%= cartoon.id %>);
      function chooseCartoon<%= cartoon.id %>(){
        imageHolderContext.globalAlpha = 0.1;
        var image = document.getElementById("cartoon-<%= cartoon.id %>");
        imageHolderContext.drawImage(image, canvas.height/4, 0, canvas.width-300, canvas.height);
        context.globalAlpha = 1;
      }
    <% end %>
  }
}

function setUpEnvironment(){
  setTray();
  setCanvas();
  $("#tray").on("click", makeSelections)
  $("#all-cartoons").on("click", chooseImage);
  $("#canvas").on("mousedown", mouseDown);
  $("#clear").on("click", $("#clear").on("click", function(){context.clearRect(0, 0, canvas.width, canvas.height);}))

  function setCanvas(){
    var canvasDiv = document.getElementById('canvasDiv');
    var imageHolder = document.createElement("canvas");
    imageHolder.setAttribute("id", "image-holder");

    var canvas = document.createElement("canvas");
    canvas.setAttribute("id", "canvas");
    canvas.setAttribute("width", "900px");
    canvas.setAttribute("height", "500px");

    canvasDiv.appendChild(imageHolder);
    canvasDiv.appendChild(canvas);
    context = canvas.getContext("2d");
    imageHolderContext = imageHolder.getContext("2d");
  }

  function setTray(){
    var canvasDiv = document.getElementById("canvasDiv");
    var tray = document.createElement("div");
    tray.setAttribute("id", "tray");

    // START TRAY COMPONENTS
    var colorsDiv = document.createElement("div");
    colorsDiv.setAttribute("id", "colors");
    tray.appendChild(colorsDiv);

    var tipsDiv = document.createElement("div");
    tipsDiv.setAttribute("id", "tips");
    tray.appendChild(tipsDiv);

    var eraserDiv = document.createElement("div");
    eraserDiv.setAttribute("id", "eraser-div");
    var clearCanvas = document.createElement("button");
    clearCanvas.setAttribute("id", "clear");
    clearCanvas.innerHTML = "clear";

    eraserDiv.appendChild(clearCanvas);
    tray.appendChild(eraserDiv);
    // END TRAY COMPONENTS

    canvasDiv.appendChild(tray);
    colors();
    tips();

    function colors(){
      <% Drawing::COLORS.each do |color| %>
        var <%= color %> = document.createElement("button");
        <%= color %>.setAttribute("id", "<%= color %>");
        <%= color %>.setAttribute("style", "background-color:<%= color %>;border-radius:50%;height:50px;width:50px")
        colorsDiv.appendChild(<%= color %>);
      <% end %>
    }

    function tips(){
      <% Drawing::TIPS.each do |tip| %>
        var size<%= tip %> = document.createElement("div");
        size<%= tip %>.setAttribute("id", "size<%= tip %>");
        size<%= tip %>.setAttribute("class", "tip")
        size<%= tip %>.setAttribute("style", "background-color:black;border-radius:50%;height:<%= tip %>px;width:<%= tip %>px;display:inline-block;");
        tipsDiv.appendChild(size<%= tip %>);
      <% end %>
    }
  }
}

function makeSelections(){
  chooseColor();
  chooseTip();

  function chooseColor(){
    <% Drawing::COLORS.each do |color| %>
      $("#<%= color %>").on("click", <%= color %>);
     
      function <%= color %>(){
        context.strokeStyle = "<%= color %>";
      }
    <% end %>
  }

  function chooseTip(){
    <% Drawing::TIPS.each do |tip| %>
      $("#size<%= tip %>").on("click", chooseSize<%= tip %>);

      function chooseSize<%= tip %>(){
        context.lineWidth = <%= tip %>;
      }
    <% end %>
  }
}

function mouseDown(e){
  paint = true;
  mouseCoordinates.push([e.offsetX, e.offsetY]);
  $(this).on("mousemove", mouseMove);
}

function mouseMove(e){
  if(paint){
    mouseCoordinates.push([e.offsetX, e.offsetY]);
    $(this).on("mouseup", mouseUp);
    draw(e);
  }
}

function mouseUp(e){
  paint = false;
}

function draw(e){
  if(paint){
    context.beginPath();
    context.lineJoin = "round";
    context.lineCap = "round";

    context.moveTo(mouseCoordinates[mouseCoordinates.length-2][0], mouseCoordinates[mouseCoordinates.length-2][1])
    context.lineTo(mouseCoordinates[mouseCoordinates.length-1][0], mouseCoordinates[mouseCoordinates.length-1][1])
    context.stroke();
  }
}