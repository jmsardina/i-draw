$(function(){
  setUpEnvironment();

  context.globalAlpha = 0.1
  var image = document.getElementById("source");
  context.drawImage(image, 100,100);
  context.globalAlpha = 1;

  var paint;
  mouseCoordinates = new Array();
});

function setUpEnvironment(){
  setTray();
  setCanvas();
  $("#tray").on("click", makeSelections)
  $("#canvas").on("mousedown", mouseDown);
  $("#clear").on("click", $("#clear").on("click", function(){context.clearRect(0, 0, canvas.width, canvas.height);}))

  function setCanvas(){
    var canvasDiv = document.getElementById('canvasDiv');
    var canvas = document.createElement("canvas");
    canvas.setAttribute("width", "900px");
    canvas.setAttribute("height", "700px");
    canvas.setAttribute("id", "canvas");
    canvas.setAttribute("style", "border:1px solid;margin:auto")
    canvasDiv.appendChild(canvas);

    context = canvas.getContext("2d");
  }

  function setTray(){
    var canvasDiv = document.getElementById("canvasDiv");
    var tray = document.createElement("div");
    tray.setAttribute("id", "tray");
    tray.setAttribute("style", "height:100px;width:900px;background-color:yellow;border:1px solid;");

    // START TRAY COMPONENTS
    var colorsDiv = document.createElement("div");
    colorsDiv.setAttribute("id", "colors");
    tray.appendChild(colorsDiv);

    var tipsDiv = document.createElement("div");
    tipsDiv.setAttribute("id", "tips");
    tray.appendChild(tipsDiv);

    var eraserDiv = document.createElement("div");
    eraserDiv.setAttribute("id", "eraser-div");
    var clearCanvas = document.createElement("button");
    clearCanvas.setAttribute("id", "clear");
    clearCanvas.innerHTML = "clear";

    eraserDiv.appendChild(clearCanvas);
    tray.appendChild(eraserDiv);
    // END TRAY COMPONENTS

    canvasDiv.appendChild(tray);
    colors();
    tips();

    function colors(){
      <% Drawing::COLORS.each do |color| %>
        var <%= color %> = document.createElement("button");
        <%= color %>.setAttribute("id", "<%= color %>");
        <%= color %>.innerHTML = "<%= color %>";
        colorsDiv.appendChild(<%= color %>);
      <% end %>
    }

    function tips(){
      <% Drawing::TIPS.each do |tip| %>
        var size<%= tip %> = document.createElement("button");
        size<%= tip %>.setAttribute("id", "size<%= tip %>");
        size<%= tip %>.innerHTML = "size<%= tip %>";
        tipsDiv.appendChild(size<%= tip %>);
      <% end %>
    }
  }
}

function makeSelections(){
  chooseColor();
  chooseTip();

  function chooseColor(){
    <% Drawing::COLORS.each do |color| %>
      $("#<%= color %>").on("click", <%= color %>);
     
      function <%= color %>(){
        context.strokeStyle = "<%= color %>";
      }
    <% end %>
  }

  function chooseTip(){
    <% Drawing::TIPS.each do |tip| %>
      $("#size<%= tip %>").on("click", chooseSize<%= tip %>);

      function chooseSize<%= tip %>(){
        context.lineWidth = <%= tip %>;
      }
    <% end %>
  }
}

function mouseDown(e){
  paint = true;
  mouseCoordinates.push([e.offsetX, e.offsetY]);
  $(this).on("mousemove", mouseMove);
}

function mouseMove(e){
  if(paint){
    mouseCoordinates.push([e.offsetX, e.offsetY]);
    $(this).on("mouseup", mouseUp);
    draw(e);
  }
}

function mouseUp(e){
  paint = false;
}

function draw(e){
  if(paint){
    context.beginPath();
    context.lineJoin = "round";
    context.lineCap = "round";

    context.moveTo(mouseCoordinates[mouseCoordinates.length-2][0], mouseCoordinates[mouseCoordinates.length-2][1])
    context.lineTo(mouseCoordinates[mouseCoordinates.length-1][0], mouseCoordinates[mouseCoordinates.length-1][1])
    context.stroke();
  }
}